name: Build and Push for master
on:
  push:
    branches:
      - master
jobs:
  build-images-for-master:
    strategy:
      fail-fast: true
      matrix:
        image:
          - name: kfp-api-server
            dockerfile: backend/Dockerfile
            context: .
          - name: kfp-frontend
            dockerfile: frontend/Dockerfile
            context: .
          - name: kfp-persistence-agent
            dockerfile: backend/Dockerfile.persistenceagent
            context: .
          - name: kfp-scheduled-workflow-controller
            dockerfile: backend/Dockerfile.scheduledworkflow
            context: .
          - name: kfp-viewer-crd-controller
            dockerfile: backend/Dockerfile.viewercontroller
            context: .
          - name: kfp-visualization-server
            dockerfile: backend/Dockerfile.visualization
            context: .
          - name: kfp-launcher
            dockerfile: backend/Dockerfile.launcher
            context: .
          - name: kfp-driver
            dockerfile: backend/Dockerfile.driver
            context: .
          - name: kfp-cache-deployer
            dockerfile: backend/src/cache/deployer/Dockerfile
            context: .
          - name: kfp-cache-server
            dockerfile: backend/Dockerfile.cacheserver
            context: .
          - name: kfp-metadata-envoy
            dockerfile: third_party/metadata_envoy/Dockerfile
            context: .
          - name: kfp-metadata-writer
            dockerfile: backend/metadata_writer/Dockerfile
            context: .
          - name: kfp-inverse-proxy-agent
            dockerfile: proxy/Dockerfile
            context: ./proxy

        arch:
          - arch_name: amd64
            runs_on: ubuntu-latest
            platform: linux/amd64
          - arch_name: arm64
            runs_on: ubuntu-24.04-arm
            platform: linux/arm64

        exclude:
          - image: { name: kfp-metadata-writer }
            arch: { arch_name: arm64 }

          - image: { name: kfp-inverse-proxy-agent }
            arch: { arch_name: arm64 }

    uses: ./.github/workflows/build-and-push.yml
    secrets: inherit
    with:
      src_branch: master
      target_tag: master
      arch_tag: ${{ matrix.arch.arch_name }}
      overwrite_imgs: True
      set_latest: False
      add_sha_tag: False
      app_to_build: ${{ matrix.image.name }}
      image_context: ${{ matrix.image.context }}
      docker_file: ${{ matrix.image.dockerfile }}
      platforms: ${{ matrix.arch.platform }}
      runs_on: ${{ matrix.arch.runs_on }}
      push: true

  create-manifests:
    needs: build-images-for-master
    strategy:
      fail-fast: true
      matrix:
        component:
          - image: kfp-api-server
          - image: kfp-frontend
          - image: kfp-persistence-agent
          - image: kfp-scheduled-workflow-controller
          - image: kfp-viewer-crd-controller
          - image: kfp-visualization-server
          - image: kfp-launcher
          - image: kfp-driver
          - image: kfp-cache-deployer
          - image: kfp-cache-server
          - image: kfp-metadata-writer
          - image: kfp-metadata-envoy
          - image: kfp-inverse-proxy-agent
    uses: ./.github/workflows/create-manifest.yml
    secrets: inherit
    with:
      target_tag: master
      app_to_build: ${{ matrix.component.image }}
      set_latest: 'false'
